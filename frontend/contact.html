<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Li√™n h·ªá - Adidas Shop</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { background: #f5f5f5; }
        .page-content { max-width: 800px; margin: 100px auto 40px; padding: 20px; }
        .white-box { background: white; padding: 50px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .page-title { text-align: center; margin-bottom: 15px; color: #000; font-size: 36px; font-weight: 700; }
        .page-subtitle { text-align: center; color: #666; margin-bottom: 40px; font-size: 16px; }
        .input-group { margin-bottom: 25px; }
        .input-label { display: block; margin-bottom: 10px; font-weight: 600; color: #000; font-size: 15px; }
        .input-field { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 4px; font-size: 15px; font-family: inherit; background: white; color: #000; box-sizing: border-box; }
        .input-field:focus { outline: none; border-color: #000; box-shadow: 0 0 0 3px rgba(0,0,0,0.1); }
        .input-textarea { resize: vertical; min-height: 120px; }
        .submit-btn { width: 100%; padding: 18px; background: #000; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .submit-btn:hover { background: #333; }
        .info-section { margin-top: 50px; padding-top: 40px; border-top: 2px solid #eee; }
        .info-title { margin-bottom: 25px; color: #000; font-size: 24px; font-weight: 700; }
        .info-item { margin-bottom: 18px; color: #333; line-height: 1.8; font-size: 16px; }
        .info-item strong { color: #000; margin-right: 10px; font-weight: 700; }
        .notification-item { background: #f8f9fa; border-left: 4px solid #4CAF50; padding: 20px; margin-bottom: 20px; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        .notification-item:hover { background: #e8f5e9; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .notification-item.unread { background: #e8f5e9; }
        .notification-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .notification-subject { font-weight: 700; font-size: 18px; color: #000; }
        .notification-date { font-size: 13px; color: #666; }
        .notification-preview { color: #666; font-size: 14px; margin-top: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .notification-message { background: white; padding: 15px; border-radius: 4px; margin: 10px 0; color: #333; white-space: pre-wrap; }
        .notification-reply { background: #fff; padding: 15px; border-radius: 4px; border-left: 3px solid #4CAF50; margin-top: 10px; }
        .notification-reply-label { font-weight: 600; color: #4CAF50; margin-bottom: 8px; font-size: 14px; }
        .notification-reply-text { color: #333; white-space: pre-wrap; line-height: 1.6; }
        .no-notifications { text-align: center; padding: 40px; color: #999; font-size: 16px; }
        
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold; color: #999; cursor: pointer; }
        .modal-close:hover { color: #000; }
        .modal-title { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: #000; }
        .modal-section { margin-bottom: 20px; }
        .modal-label { font-weight: 600; color: #666; margin-bottom: 8px; font-size: 14px; }
        .modal-text { background: #f8f9fa; padding: 15px; border-radius: 4px; white-space: pre-wrap; line-height: 1.6; }
        .modal-reply-box { background: #e8f5e9; border-left: 4px solid #4CAF50; padding: 20px; border-radius: 4px; }
        .btn-mark-read { background: #4CAF50; color: white; border: none; padding: 12px 30px; border-radius: 4px; font-size: 15px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
        .btn-mark-read:hover { background: #45a049; }
        
        /* Tabs */
        .notification-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .notification-tab { padding: 12px 24px; background: none; border: none; font-size: 16px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .notification-tab:hover { color: #000; }
        .notification-tab.active { color: #000; border-bottom-color: #000; }
        .notification-tab-badge { background: #f44336; color: white; border-radius: 50%; padding: 2px 8px; font-size: 12px; margin-left: 6px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .history-item { opacity: 0.85; }
        .history-item:hover { opacity: 1; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo"><h1>ADIDAS</h1></div>
            <nav>
                <ul>
                    <li><a href="index.html">Trang ch·ªß</a></li>
                    <li><a href="index.html#products">S·∫£n ph·∫©m</a></li>
                    <li><a href="contact.html">Li√™n h·ªá</a></li>
                    <li><a href="index.html#cart">Gi·ªè h√†ng (<span id="cart-count">0</span>)</a></li>
                    <li id="authNav">
                        <a href="login.html" class="btn-login">ƒêƒÉng nh·∫≠p</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="page-content">
        <div class="white-box">
            <h2 class="page-title">Li√™n h·ªá t∆∞ v·∫•n</h2>
            <p class="page-subtitle">ƒê·ªÉ l·∫°i th√¥ng tin, ch√∫ng t√¥i s·∫Ω li√™n h·ªá t∆∞ v·∫•n cho b·∫°n</p>

            <form id="myForm">
                <div class="input-group">
                    <label class="input-label">H·ªç v√† t√™n *</label>
                    <input type="text" id="nameInput" class="input-field" required placeholder="Nh·∫≠p h·ªç v√† t√™n">
                </div>

                <div class="input-group">
                    <label class="input-label">Email *</label>
                    <input type="email" id="emailInput" class="input-field" required placeholder="Nh·∫≠p email">
                </div>

                <div class="input-group">
                    <label class="input-label">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" id="phoneInput" class="input-field" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                </div>

                <div class="input-group">
                    <label class="input-label">Ch·ªß ƒë·ªÅ *</label>
                    <select id="subjectInput" class="input-field" required>
                        <option value="">Ch·ªçn ch·ªß ƒë·ªÅ</option>
                        <option value="T∆∞ v·∫•n s·∫£n ph·∫©m">T∆∞ v·∫•n s·∫£n ph·∫©m</option>
                        <option value="H·ªèi v·ªÅ ƒë∆°n h√†ng">H·ªèi v·ªÅ ƒë∆°n h√†ng</option>
                        <option value="Khi·∫øu n·∫°i">Khi·∫øu n·∫°i</option>
                        <option value="G√≥p √Ω">G√≥p √Ω</option>
                        <option value="Kh√°c">Kh√°c</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label">N·ªôi dung *</label>
                    <textarea id="messageInput" class="input-field input-textarea" required placeholder="Nh·∫≠p n·ªôi dung c·∫ßn t∆∞ v·∫•n"></textarea>
                </div>

                <button type="submit" class="submit-btn">G·ª≠i y√™u c·∫ßu</button>
            </form>

            <!-- Notification Section for Logged-in Users -->
            <div id="notificationSection" style="display: none; margin-top: 50px; padding-top: 40px; border-top: 2px solid #eee;">
                <h3 class="info-title">üì¨ Ph·∫£n h·ªìi t·ª´ ch√∫ng t√¥i</h3>
                
                <!-- Tabs -->
                <div class="notification-tabs">
                    <button class="notification-tab active" onclick="switchTab('new')">
                        üîî M·ªõi <span class="notification-tab-badge" id="newCount">0</span>
                    </button>
                    <button class="notification-tab" onclick="switchTab('history')">
                        üìã L·ªãch s·ª≠
                    </button>
                </div>
                
                <!-- New notifications -->
                <div id="newTab" class="tab-content active">
                    <div id="notificationList"></div>
                </div>
                
                <!-- History -->
                <div id="historyTab" class="tab-content">
                    <div id="historyList"></div>
                </div>
            </div>

            <div class="info-section">
                <h3 class="info-title">Th√¥ng tin li√™n h·ªá</h3>
                <p class="info-item"><strong>üìç ƒê·ªãa ch·ªâ:</strong> 123 Nguy·ªÖn Hu·ªá, Qu·∫≠n 1, TP.HCM</p>
                <p class="info-item"><strong>üìû Hotline:</strong> 1900 xxxx</p>
                <p class="info-item"><strong>üìß Email:</strong> support@adidas-shop.vn</p>
                <p class="info-item"><strong>üïê Gi·ªù l√†m vi·ªác:</strong> 8:00 - 22:00 (Th·ª© 2 - Ch·ªß nh·∫≠t)</p>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3 class="footer-title">ADIDAS SHOP</h3>
                <p class="footer-description">Chuy√™n cung c·∫•p gi√†y th·ªÉ thao Adidas ch√≠nh h√£ng v·ªõi ƒëa d·∫°ng m·∫´u m√£, phong c√°ch v√† ch·∫•t l∆∞·ª£ng ƒë·ªânh cao.</p>
                <div class="footer-social">
                    <a href="#" class="social-link">Facebook</a>
                    <a href="#" class="social-link">Instagram</a>
                    <a href="#" class="social-link">Twitter</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h4 class="footer-heading">S·∫¢N PH·∫®M</h4>
                <ul class="footer-links">
                    <li><a href="index.html#products">Gi√†y ch·∫°y b·ªô</a></li>
                    <li><a href="index.html#products">Gi√†y b√≥ng ƒë√°</a></li>
                    <li><a href="index.html#products">Gi√†y lifestyle</a></li>
                    <li><a href="index.html#products">Gi√†y b√≥ng r·ªï</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h4 class="footer-heading">H·ªñ TR·ª¢</h4>
                <ul class="footer-links">
                    <li><a href="contact.html">Li√™n h·ªá t∆∞ v·∫•n</a></li>
                    <li><a href="index.html#cart">Gi·ªè h√†ng</a></li>
                    <li><a href="profile.html">T√†i kho·∫£n</a></li>
                    <li><a href="#">Ch√≠nh s√°ch ƒë·ªïi tr·∫£</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h4 class="footer-heading">LI√äN H·ªÜ</h4>
                <ul class="footer-info">
                    <li>üìç 123 Nguy·ªÖn Hu·ªá, Q.1, TP.HCM</li>
                    <li>üìû Hotline: 1900 xxxx</li>
                    <li>üìß Email: support@adidas-shop.vn</li>
                    <li>üïê 8:00 - 22:00 (Th·ª© 2 - CN)</li>
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            <div class="container">
                <p>&copy; 2026 Adidas Shop. All rights reserved. | Thi·∫øt k·∫ø b·ªüi Adidas Vietnam</p>
            </div>
        </div>
    </footer>

    <script>
        const API_URL = 'http://localhost:3001/api';

        // Load user info and cart count on page load
        window.addEventListener('load', async function() {
            await loadUserInfo();
            await loadCartCount();
            await loadNotifications();
            await loadHistory();
        });

        // Load user info and auto-fill form
        async function loadUserInfo() {
            const token = localStorage.getItem('userToken');
            const authNav = document.getElementById('authNav');
            
            if (token) {
                try {
                    const response = await fetch(API_URL + '/auth/me', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const userName = (data.customer && data.customer.name) || data.user.email.split('@')[0];
                        const isAdmin = data.user.role === 'admin';
                        
                        // Update navigation - ch·ªâ hi·ªÉn th·ªã n√∫t qu·∫£n tr·ªã n·∫øu role l√† admin
                        if (isAdmin) {
                            authNav.innerHTML = '<a href="admin.html" class="btn-admin" style="background: #ff6b00; color: white; padding: 8px 16px; border-radius: 4px; text-decoration: none; margin-right: 10px;">‚öôÔ∏è Qu·∫£n tr·ªã</a><a href="profile.html" class="btn-login">üë§ ' + userName + '</a>';
                        } else {
                            authNav.innerHTML = '<a href="profile.html" class="btn-login">üë§ ' + userName + '</a>';
                        }
                        
                        // Auto-fill form with user info
                        if (data.customer) {
                            document.getElementById('nameInput').value = data.customer.name || '';
                            document.getElementById('emailInput').value = data.customer.email || '';
                            document.getElementById('phoneInput').value = data.customer.phone || '';
                        } else {
                            document.getElementById('emailInput').value = data.user.email || '';
                        }
                    }
                } catch (error) {
                    console.error('Load user info error:', error);
                }
            }
        }

        // Load cart count
        async function loadCartCount() {
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                document.getElementById('cart-count').textContent = '0';
                return;
            }
            
            try {
                const response = await fetch(API_URL + '/customer/cart', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const count = data.items.reduce(function(sum, item) {
                        return sum + item.quantity;
                    }, 0);
                    document.getElementById('cart-count').textContent = count;
                }
            } catch (error) {
                console.error('Load cart error:', error);
            }
        }

        // Load notifications
        async function loadNotifications() {
            const token = localStorage.getItem('userToken');
            if (!token) return;
            
            try {
                const response = await fetch(API_URL + '/customer/contact-replies', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (response.ok) {
                    const replies = await response.json();
                    
                    const notificationSection = document.getElementById('notificationSection');
                    const notificationList = document.getElementById('notificationList');
                    const newCount = document.getElementById('newCount');
                    
                    if (replies.length > 0) {
                        notificationSection.style.display = 'block';
                        newCount.textContent = replies.length;
                        
                        const html = replies.map(function(reply) {
                            return '<div class="notification-item" onclick="showNotificationDetail(' + reply.id + ', false)" data-id="' + reply.id + '">' +
                                '<div class="notification-header">' +
                                    '<div class="notification-subject">üì© ' + reply.subject + '</div>' +
                                    '<div class="notification-date">' + new Date(reply.reply_date).toLocaleString('vi-VN') + '</div>' +
                                '</div>' +
                                '<div class="notification-preview">‚úì ƒê√£ c√≥ ph·∫£n h·ªìi - Click ƒë·ªÉ xem chi ti·∫øt</div>' +
                            '</div>';
                        }).join('');
                        
                        notificationList.innerHTML = html;
                        
                        // Store replies data globally
                        window.notificationReplies = replies;
                    } else {
                        notificationSection.style.display = 'block';
                        newCount.textContent = '0';
                        notificationList.innerHTML = '<div class="no-notifications">Kh√¥ng c√≥ ph·∫£n h·ªìi m·ªõi</div>';
                    }
                }
            } catch (error) {
                console.error('Load notifications error:', error);
            }
        }

        // Load history
        async function loadHistory() {
            const token = localStorage.getItem('userToken');
            if (!token) return;
            
            try {
                const response = await fetch(API_URL + '/customer/contact-history', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                
                if (response.ok) {
                    const history = await response.json();
                    const historyList = document.getElementById('historyList');
                    
                    if (history.length > 0) {
                        const html = history.map(function(reply) {
                            return '<div class="notification-item history-item" onclick="showNotificationDetail(' + reply.id + ', true)" data-id="' + reply.id + '">' +
                                '<div class="notification-header">' +
                                    '<div class="notification-subject">üì© ' + reply.subject + '</div>' +
                                    '<div class="notification-date">' + new Date(reply.reply_date).toLocaleString('vi-VN') + '</div>' +
                                '</div>' +
                                '<div class="notification-preview">‚úì ƒê√£ ƒë·ªçc - Click ƒë·ªÉ xem l·∫°i</div>' +
                            '</div>';
                        }).join('');
                        
                        historyList.innerHTML = html;
                        
                        // Store history data globally
                        window.historyReplies = history;
                    } else {
                        historyList.innerHTML = '<div class="no-notifications">Ch∆∞a c√≥ l·ªãch s·ª≠ ph·∫£n h·ªìi</div>';
                    }
                }
            } catch (error) {
                console.error('Load history error:', error);
            }
        }

        // Switch tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.notification-tab').forEach(function(btn) {
                btn.classList.remove('active');
            });
            event.target.closest('.notification-tab').classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(function(content) {
                content.classList.remove('active');
            });
            
            if (tab === 'new') {
                document.getElementById('newTab').classList.add('active');
            } else {
                document.getElementById('historyTab').classList.add('active');
            }
        }

        // Show notification detail in modal
        function showNotificationDetail(id, isHistory) {
            const replies = isHistory ? window.historyReplies : window.notificationReplies;
            const reply = replies.find(function(r) { return r.id === id; });
            if (!reply) return;
            
            const modalHtml = '<div class="modal show" id="notificationModal">' +
                '<div class="modal-content">' +
                    '<span class="modal-close" onclick="closeNotificationModal()">&times;</span>' +
                    '<h2 class="modal-title">üì© ' + reply.subject + '</h2>' +
                    '<div class="modal-section">' +
                        '<div class="modal-label">Ng√†y g·ª≠i:</div>' +
                        '<div>' + new Date(reply.created_at).toLocaleString('vi-VN') + '</div>' +
                    '</div>' +
                    '<div class="modal-section">' +
                        '<div class="modal-label">C√¢u h·ªèi c·ªßa b·∫°n:</div>' +
                        '<div class="modal-text">' + reply.message + '</div>' +
                    '</div>' +
                    '<div class="modal-section">' +
                        '<div class="modal-reply-box">' +
                            '<div class="modal-label" style="color: #4CAF50; font-size: 16px; margin-bottom: 10px;">‚úì Ph·∫£n h·ªìi t·ª´ Admin:</div>' +
                            '<div class="modal-text" style="background: white;">' + reply.admin_reply + '</div>' +
                            '<div style="margin-top: 10px; font-size: 13px; color: #666;">Ng√†y tr·∫£ l·ªùi: ' + new Date(reply.reply_date).toLocaleString('vi-VN') + '</div>' +
                        '</div>' +
                    '</div>' +
                    (isHistory ? 
                        '<div style="margin-top: 20px; text-align: center; color: #666; font-size: 14px;">‚úì ƒê√£ ƒë·ªçc</div>' :
                        '<div style="margin-top: 20px; text-align: center;">' +
                            '<button onclick="markAsRead(' + reply.id + ')" style="background: #4CAF50; color: white; border: none; padding: 12px 30px; border-radius: 4px; font-size: 15px; font-weight: 600; cursor: pointer;">‚úì ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</button>' +
                        '</div>'
                    ) +
                '</div>' +
            '</div>';
            
            // Remove existing modal if any
            const existingModal = document.getElementById('notificationModal');
            if (existingModal) existingModal.remove();
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Close on background click
            document.getElementById('notificationModal').addEventListener('click', function(e) {
                if (e.target === this) closeNotificationModal();
            });
        }

        function closeNotificationModal() {
            const modal = document.getElementById('notificationModal');
            if (modal) modal.remove();
        }

        // Mark notification as read
        async function markAsRead(id) {
            const token = localStorage.getItem('userToken');
            if (!token) return;
            
            try {
                const response = await fetch(API_URL + '/customer/contact-replies/' + id + '/mark-read', {
                    method: 'PUT',
                    headers: { 
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    // Close modal
                    closeNotificationModal();
                    
                    // Show success message
                    alert('‚úì ƒê√£ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc!');
                    
                    // Reload notifications and history
                    await loadNotifications();
                    await loadHistory();
                    
                    // Update badge count
                    if (window.loadNotificationCount) {
                        window.loadNotificationCount();
                    }
                } else {
                    alert('‚ùå L·ªói ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc');
                }
            } catch (error) {
                console.error('Mark as read error:', error);
                alert('‚ùå L·ªói k·∫øt n·ªëi');
            }
        }

        // Handle form submission
        document.getElementById('myForm').onsubmit = async function(e) {
            e.preventDefault();
            
            var nameVal = document.getElementById('nameInput').value;
            var emailVal = document.getElementById('emailInput').value;
            var phoneVal = document.getElementById('phoneInput').value;
            var subjectVal = document.getElementById('subjectInput').value;
            var messageVal = document.getElementById('messageInput').value;
            
            try {
                var response = await fetch(API_URL + '/contact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name: nameVal, 
                        email: emailVal, 
                        phone: phoneVal, 
                        subject: subjectVal, 
                        message: messageVal 
                    })
                });
                
                var data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ ' + data.message);
                    // Reset only subject and message, keep user info
                    document.getElementById('subjectInput').value = '';
                    document.getElementById('messageInput').value = '';
                } else {
                    alert('‚ùå ' + (data.error || 'C√≥ l·ªói x·∫£y ra'));
                }
            } catch (error) {
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
            }
        };
    </script>
</body>
</html>
